name: Ejecutar Pruebas Manualmente - Sylius API

on:
  workflow_dispatch:
    inputs:
      mark:
        description: "Selecciona la marca para ejecutar las pruebas"
        required: true
        default: "administrator"
        type: choice
        options:
          - administrator
          - avatar_images
          - promotions
          - product_reviews
          - marketing
          - e2e
          - functional_positive
          - functional_negative
          - functional_validation
          - functional_edgecase
          - security
          - regression
          - concurrent
          - high
          - medium
          - low

jobs:
  pruebas:
    runs-on: ubuntu-latest

    steps:

    - name: Descargar cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Establecer variables de entorno desde secrets
      run: |
        echo "BASE_URL=${{ secrets.BASE_URL }}" >> $GITHUB_ENV
        echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> $GITHUB_ENV
        echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> $GITHUB_ENV

    - name: Instalar dependencias necesarias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Ejecutar tests con pytest y generar allure-results
      run: |
        if [ -n "${{ github.event.inputs.mark }}" ]; then
          echo "Ejecutando pytest con marker: ${{ github.event.inputs.mark }}"
          pytest -m "${{ github.event.inputs.mark }}" --disable-warnings -v --alluredir=reports/allure-results
        else
          echo "Ejecutando todos los tests"
          pytest --disable-warnings -v --alluredir=reports/allure-results
        fi

    - name: Load test report history
      uses: actions/checkout@v4
      if: always()
      continue-on-error: true
      with:
        ref: report-allure
        path: report-allure

    - name: Build Allure Report
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        gh_pages: report-allure
        allure_results: reports/allure-results
        allure_history: allure-history

    - name: Publish Allure Report to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: always()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: report-allure
        publish_dir: allure-history

    - name: Resumen final
      run: |
        echo "Pruebas completadas con la marca seleccionada: ${{ github.event.inputs.mark }}."
        echo "Reportes Allure generados y publicados correctamente."
