name: Ejecutar Pruebas Manualmente - Sylius API

on:
  workflow_dispatch:
    inputs:
      mark:
        description: 'Selecciona la marca para ejecutar las pruebas'
        required: true
        default: 'administrator'
        type: choice
        options:
          - administrator
          - avatar_images
          - promotions
          - product_reviews
          - marketing
          - e2e
          - functional_positive
          - functional_negative
          - functional_validation
          - functional_edgecase
          - security
          - regression
          - concurrent
          - high
          - medium
          - low

jobs:
  pruebas:
    name: Ejecutar pruebas en la rama main
    runs-on: ubuntu-latest

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

    steps:
    # PASO 1: Descargar código
    - name: Descargar código de la rama main
      uses: actions/checkout@v4
      with:
        ref: main

    # PASO 2: Configurar Python
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # PASO 3: Instalar dependencias
    - name: Instalar dependencias necesarias
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install pytest-html allure-pytest

    # PASO 4: Instalar Allure CLI
    - name: Instalar Allure CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip
        wget https://github.com/allure-framework/allure2/releases/latest/download/allure-2.30.0.zip
        unzip allure-2.30.0.zip -d /opt/allure
        sudo ln -s /opt/allure/allure-2.30.0/bin/allure /usr/bin/allure

    # PASO 5: Crear archivo .env
    - name: Crear archivo .env
      run: |
        echo "BASE_URL=${{ env.BASE_URL }}" > .env
        echo "ADMIN_EMAIL=${{ env.ADMIN_EMAIL }}" >> .env
        echo "ADMIN_PASSWORD=${{ env.ADMIN_PASSWORD }}" >> .env
        echo ".env generado con las variables de entorno."

    # PASO 6: Crear carpetas para reportes
    - name: Crear carpetas de reportes
      run: mkdir -p reports/allure-results reports/allure-report

    # PASO 7: Ejecutar pruebas Pytest
    - name: Ejecutar pruebas con Pytest y generar reportes
      run: |
        echo "Ejecutando pruebas con la marca seleccionada: ${{ inputs.mark }}..."
        pytest -m "${{ inputs.mark }}" \
          --alluredir=reports/allure-results \
          --html=reports/resultados.html \
          --self-contained-html -v -s || true

    # PASO 8: Generar reporte Allure
    - name: Generar reporte Allure
      run: |
        allure generate reports/allure-results -o reports/allure-report --clean || echo "No se generó reporte Allure"

    # PASO 9: Subir reportes HTML y Allure como artefactos
    - name: Subir reportes generados
      uses: actions/upload-artifact@v4
      with:
        name: reporte-sylius-${{ inputs.mark }}
        path: |
          reports/resultados.html
          reports/allure-report

    # PASO 10: Mostrar resumen
    - name: Resumen final
      run: |
        echo " Pruebas completadas con la marca seleccionada: ${{ inputs.mark }}."
        echo " Reportes generados y subidos correctamente."
