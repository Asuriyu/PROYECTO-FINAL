name: Ejecutar Pruebas Manualmente - Sylius API

on:
  workflow_dispatch:
    inputs:
      mark:
        description: "Selecciona la marca para ejecutar las pruebas"
        required: true
        default: "administrator"
        type: choice
        options:
          - administrator
          - avatar_images
          - promotions
          - product_reviews
          - marketing
          - e2e
          - functional_positive
          - functional_negative
          - functional_validation
          - functional_edgecase
          - security
          - regression
          - concurrent
          - high
          - medium
          - low

jobs:
  pruebas:
    runs-on: ubuntu-latest
    name: Ejecutar pruebas en Sylius API

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

    steps:

    - name: Descargar código
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Instalar dependencias necesarias
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install pytest-html allure-pytest

    - name: Instalar Allure CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y allure

    # Verificar instalación de Allure (debug)
    - name: Verificar Allure CLI
      run: allure --version

    - name: Crear archivo .env
      run: |
        echo "BASE_URL=${{ env.BASE_URL }}" > .env
        echo "ADMIN_EMAIL=${{ env.ADMIN_EMAIL }}" >> .env
        echo "ADMIN_PASSWORD=${{ env.ADMIN_PASSWORD }}" >> .env

    - name: Ejecutar pruebas con Pytest
      run: |
        echo "Ejecutando pruebas con la marca: ${{ inputs.mark }}"
        pytest -m "${{ inputs.mark }}" \
          --alluredir=reports/allure-results \
          --html=reports/resultados.html \
          --self-contained-html \
          -v -s || true

    - name: Generar reporte Allure
      run: |
        echo "Generando reporte Allure..."
        allure generate reports/allure-results -o reports/allure-report --clean

    - name: Subir reportes generados
      uses: actions/upload-artifact@v4
      with:
        name: reporte-sylius-${{ inputs.mark }}
        path: |
          reports/resultados.html
          reports/allure-report

    - name: Resumen final
      run: |
        echo "Pruebas completadas con la marca seleccionada: ${{ inputs.mark }}."
        echo "Reportes generados y subidos correctamente."
