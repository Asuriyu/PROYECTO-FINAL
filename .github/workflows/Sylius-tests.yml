name: Ejecutar Pruebas Manualmente - Sylius API

on:
  workflow_dispatch:
    inputs:
      mark:
        description: 'Selecciona la marca para ejecutar las pruebas'
        required: true
        default: 'administrator'
        type: choice
        options:
          - administrator
          - avatar_images
          - promotions
          - product_reviews
          - marketing
          - e2e
          - functional_positive
          - functional_negative
          - functional_validation
          - functional_edgecase
          - security
          - regression
          - concurrent
          - high
          - medium
          - low

jobs:

  pruebas:
    name: Ejecutar pruebas en la rama main
    runs-on: ubuntu-latest

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

    steps:

    - name: Descargar código de la rama main
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Instalar dependencias necesarias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-html allure-pytest

    - name: Instalar Allure CLI (última versión)
      run: |
        sudo apt-get update
        sudo apt-get install -y default-jre unzip curl
        LATEST_VERSION=$(curl -s https://api.github.com/repos/allure-framework/allure2/releases/latest | grep tag_name | cut -d '"' -f 4)
        echo "Instalando Allure versión $LATEST_VERSION"
        curl -L -o allure.zip https://github.com/allure-framework/allure2/releases/download/$LATEST_VERSION/allure-$LATEST_VERSION.zip
        unzip allure.zip -d /opt/allure
        sudo ln -s /opt/allure/allure-$LATEST_VERSION/bin/allure /usr/bin/allure

    - name: Crear archivo .env
      run: |
        echo "BASE_URL=${{ env.BASE_URL }}" > .env
        echo "ADMIN_EMAIL=${{ env.ADMIN_EMAIL }}" >> .env
        echo "ADMIN_PASSWORD=${{ env.ADMIN_PASSWORD }}" >> .env

    - name: Limpiar reportes anteriores
      run: |
        rm -rf reports/allure-results/*
        rm -rf reports/allure-report/*
        mkdir -p reports/allure-results reports/allure-report

    - name: Ejecutar pruebas con Pytest
      run: |
        echo "Ejecutando pruebas con la marca seleccionada: ${{ inputs.mark }}"
        pytest -m "${{ inputs.mark }}" \
          --alluredir=reports/allure-results \
          --html=reports/resultados.html \
          --self-contained-html -v -s || true

    - name: Generar reporte Allure
      run: |
        allure generate reports/allure-results -o reports/allure-report --clean

    - name: Empaquetar reporte Allure
      run: |
        cd reports
        zip -r allure-report.zip allure-report

    - name: Subir artifacts
      uses: actions/upload-artifact@v4
      with:
        name: reporte-sylius-${{ inputs.mark }}
        path: |
          reports/resultados.html
          reports/allure-report.zip

    - name: Finalización
      run: |
        echo "Pruebas completadas para la marca: ${{ inputs.mark }}"
        echo "Reportes generados correctamente."

  publicar_allure:
    name: Publicar reporte en GitHub Pages
    needs: pruebas
    runs-on: ubuntu-latest

    steps:

    - name: Descargar artifacts
      uses: actions/download-artifact@v4
      with:
        name: reporte-sylius-${{ inputs.mark }}

    - name: Descomprimir reporte Allure
      run: |
        unzip allure-report.zip -d .
        ls -R .

    - name: Deploy a GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./allure-report

    - name: Finalización publicación
      run: |
        echo "El reporte Allure ha sido publicado correctamente en GitHub Pages."
