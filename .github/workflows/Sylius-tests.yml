name: Ejecutar Pruebas Manualmente - Sylius API

on:
  workflow_dispatch:
    inputs:
      mark:
        description: 'Selecciona la marca para ejecutar las pruebas'
        required: true
        default: 'administrator'
        type: choice
        options:
          - administrator
          - avatar_images
          - promotions
          - product_reviews
          - marketing
          - e2e
          - functional_positive
          - functional_negative
          - functional_validation
          - functional_edgecase
          - security
          - regression
          - concurrent
          - high
          - medium
          - low

jobs:
  pruebas:
    name: Ejecutar pruebas en la rama main
    runs-on: ubuntu-latest

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

    steps:
    - name: Descargar código de la rama main
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Instalar dependencias necesarias
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install pytest-html allure-pytest

    - name: Instalar Allure CLI
      uses: allure-framework/actions/setup@v1

    - name: Crear archivo .env
      run: |
        echo "BASE_URL=${{ env.BASE_URL }}" > .env
        echo "ADMIN_EMAIL=${{ env.ADMIN_EMAIL }}" >> .env
        echo "ADMIN_PASSWORD=${{ env.ADMIN_PASSWORD }}" >> .env
        echo ".env generado con las variables de entorno."

    - name: Crear carpetas de reportes
      run: mkdir -p reports/allure-results reports/allure-report

    - name: Ejecutar pruebas con Pytest y generar reportes
      run: |
        echo "Ejecutando pruebas con la marca seleccionada: ${{ inputs.mark }}..."
        pytest -m "${{ inputs.mark }}" \
          --alluredir=reports/allure-results \
          --html=reports/resultados.html \
          --self-contained-html -v -s || true

    - name: Generar reporte Allure
      run: |
        allure generate reports/allure-results -o reports/allure-report --clean || echo "No se generó reporte Allure"

    - name: Subir reportes generados
      uses: actions/upload-artifact@v4
      with:
        name: reporte-sylius-${{ inputs.mark }}
        path: |
          reports/resultados.html
          reports/allure-report

    - name: Resumen final
      run: |
        echo " Pruebas completadas con la marca seleccionada: ${{ inputs.mark }}."
        echo " Reportes generados y subidos correctamente."
